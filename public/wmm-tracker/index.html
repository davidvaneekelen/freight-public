<!--
  F.R.E.I.G.H.T. Wing Mining Mission Tracker
  ------------------------------------------
  Author    : F.R.E.I.G.H.T. (Fleet Resource Expeditors In Galactic Hauling & Transport)
  Website   : https://freight.associates
  Purpose   : Tool to analyze, monitor and track status of Wing Mining Missions across multiple characters
  License   : CC BY 4.0 (Attribution)

  You are free to share, use, and adapt this code for any purpose - including commercial use -
  as long as you provide clear attribution to the F.R.E.I.G.H.T. initiative (https://freight.associates).
-->

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elite Dangerous Mining Mission Manager</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: monospace;
            padding: 2rem;
            background: #192946;
            color: #f7e8a3;
            line-height: 1.5;
        }

        .container {
            max-width: 72rem;
            margin: 0 auto;
        }

        .block {
            background: #312E81;
            padding: 1rem;
            border-radius: 1rem;
            margin-bottom: 2rem;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
            border: 1px solid #000000;
        }

        .card {
            background: #312E81;
            border-radius: 1rem;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
            border: 1px solid #000000;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.875rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: #f7e8a3;
        }

        .subheader {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #f7e8a3;
        }

        .form-row {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            padding: 1rem;
            background-color: #192946;
            border-radius: 0.5rem;
            border: 1px solid #f7e8a355;
        }

        .form-group {
            flex: 1;
        }

        label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #f7e8a3;
            margin-bottom: 0.25rem;
        }

        input[type="text"],
        input[type="number"] {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid #f7e8a355;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            background: #192946;
            color: #f7e8a3;
            font-family: monospace;
        }

        input[type="text"]:focus,
        input[type="number"]:focus {
            outline: none;
            border-color: #f7e8a3;
            box-shadow: 0 0 0 2px rgba(247, 232, 163, 0.2);
        }

        input[type="file"] {
            width: 100%;
            padding: 0.5rem;
            border: 2px dashed #f7e8a355;
            border-radius: 0.5rem;
            background: #192946;
            color: #f7e8a3;
            font-family: monospace;
        }

        button {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.375rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-family: monospace;
        }

        .btn-primary {
            background-color: #f7e8a3;
            color: #192946;
        }

        .btn-primary:hover {
            background-color: #e6d992;
        }

        .btn-primary:disabled {
            background-color: #6b7280;
            cursor: not-allowed;
        }

        .btn-green {
            background-color: #166534;
            color: #f7e8a3;
        }

        .btn-green:hover {
            background-color: #15803d;
        }

        .btn-red {
            background-color: #dc2626;
            color: #f7e8a3;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }

        .btn-red:hover {
            background-color: #b91c1c;
        }

        .tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .tag {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .tag-green {
            background-color: #166534;
            color: #f7e8a3;
        }

        .tag-blue {
            background-color: #1e40af;
            color: #f7e8a3;
            cursor: pointer;
        }

        .tag-blue:hover {
            background-color: #1d4ed8;
        }

        .tag-files {
            background-color: #166534;
            color: #f7e8a3;
            font-size: 0.75rem;
        }

        .file-list {
            max-height: 8rem;
            overflow-y: auto;
            border: 1px solid #f7e8a355;
            border-radius: 0.375rem;
            padding: 0.5rem;
            background: #192946;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid #f7e8a355;
        }

        th,
        td {
            padding: 0.75rem;
            border: 1px solid #f7e8a355;
            text-align: left;
        }

        th {
            background-color: #192946;
            font-weight: 600;
            color: #f7e8a3;
        }

        tr:hover {
            background-color: rgba(247, 232, 163, 0.1);
        }

        .trip-card {
            border: 1px solid #f7e8a355;
            border-radius: 0.5rem;
            overflow: hidden;
            margin-bottom: 1.5rem;
        }

        .trip-header {
            background-color: #1e40af;
            border-bottom: 1px solid #f7e8a355;
            padding: 0.75rem 1rem;
            font-size: 1.125rem;
            font-weight: 600;
            color: #f7e8a3;
        }

        .trip-table {
            font-size: 0.875rem;
        }

        .trip-table th {
            background-color: #192946;
            border-bottom: 1px solid #f7e8a355;
            min-width: 8rem;
        }

        .trip-table td.action-col {
            background-color: #192946;
            font-weight: 500;
            border-right: 1px solid #f7e8a355;
        }

        .checkbox-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .checkbox-row input[type="checkbox"] {
            width: 1rem;
            height: 1rem;
            flex-shrink: 0;
        }

        .strikethrough {
            text-decoration: line-through;
            color: #6b7280;
        }

        .text-center {
            text-align: center;
        }

        .text-right {
            text-align: right;
        }

        .font-mono {
            font-family: monospace;
        }

        .text-gray {
            color: #6b7280;
        }

        .text-red {
            color: #dc2626;
        }

        .text-green {
            color: #16a34a;
        }

        .text-blue {
            color: #3b82f6;
        }

        .cursor-pointer {
            cursor: pointer;
        }

        .expandable-row {
            cursor: pointer;
        }

        .expandable-row:hover {
            background-color: rgba(247, 232, 163, 0.1);
        }

        .expanded-content {
            background-color: #192946;
            padding: 1rem;
        }

        .mission-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
        }

        .mission-card {
            background: #192946;
            padding: 0.75rem;
            border-radius: 0.375rem;
            border: 1px solid #f7e8a355;
        }

        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .status-expired {
            background-color: #dc2626;
            color: #f7e8a3;
        }

        .status-urgent {
            background-color: #f59e0b;
            color: #192946;
        }

        .status-good {
            background-color: #16a34a;
            color: #f7e8a3;
        }

        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #6b7280;
        }

        .overflow-auto {
            overflow-x: auto;
        }

        .hidden {
            display: none;
        }

        h1, h2, h3 {
            color: #f7e8a3;
        }

        pre, code, textarea {
            background: #192946 !important;
            color: #f7e8a3 !important;
            border: 1px solid #f7e8a355;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .form-row {
                flex-direction: column;
                gap: 0.5rem;
            }

            table {
                font-size: 0.75rem;
            }

            th,
            td {
                padding: 0.5rem;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="card">
            <h1 class="header">
                üì¶ Elite Dangerous Mining Mission Manager
            </h1>
            <p class="text-gray">Upload journal files to track and optimize your wing mining missions</p>
        </div>

        <!-- File Upload -->
        <div class="card">
            <h2 class="subheader">üìÅ Select Elite Dangerous Log Folder</h2>
            <p style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.5rem;">Select a folder containing Elite
                Dangerous journal files (will scan all subfolders)</p>
            <input type="file" id="fileInput" multiple webkitdirectory>
            <div id="uploadedFiles" class="hidden">
                <p style="margin: 1rem 0 0.5rem 0; font-size: 0.875rem; color: #6b7280;">Uploaded files:</p>
                <div id="fileList" class="file-list"></div>
            </div>
        </div>

        <!-- Commanders -->
        <div id="commandersSection" class="card hidden">
            <h2 class="subheader">üë§ Commanders</h2>
            <div class="overflow-auto">
                <table id="commandersTable"></table>
            </div>
        </div>

        <!-- Commodities -->
        <div class="card">
            <h2 class="subheader">üì¶ Commodities</h2>
            <div class="form-row">
                <div class="form-group">
                    <label>Commodity Name</label>
                    <input type="text" id="newCommodity" placeholder="e.g., Gold, Silver, Bertrandite">
                </div>
                <div style="display: flex; align-items: end;">
                    <button class="btn-green" onclick="addCommodity()">Add Commodity</button>
                </div>
            </div>

            <div id="activeCommodities" class="hidden">
                <h3 style="font-size: 0.875rem; font-weight: 500; color: #f7e8a3; margin-bottom: 0.5rem;">Active
                    Commodities:</h3>
                <div id="commodityList" class="tags"></div>
            </div>

            <div id="suggestedCommodities" class="hidden">
                <h3 style="font-size: 0.875rem; font-weight: 500; color: #f7e8a3; margin-bottom: 0.5rem;">Suggested
                    Commodities (from missions):</h3>
                <div id="suggestedList" class="tags"></div>
                <p style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">Click to add to your commodities
                    list</p>
            </div>

            <div id="noCommodities" class="empty-state">
                <p>No commodities added yet.</p>
                <p>Upload log files with missions or add commodities manually to get started.</p>
            </div>
        </div>

        <!-- Fleet Carriers -->
        <div class="card">
            <h2 class="subheader">üö¢ Fleet Carriers</h2>
            <div class="form-row">
                <div class="form-group">
                    <label>Fleet Carrier Name</label>
                    <input type="text" id="newCarrier" placeholder="e.g., [FRHT] - Omega 01">
                </div>
                <div style="display: flex; align-items: end;">
                    <button class="btn-primary" onclick="addFleetCarrier()">Add Fleet Carrier</button>
                </div>
            </div>

            <div id="carrierTable" class="hidden overflow-auto"></div>

            <div id="noCarriers" class="empty-state">
                üì¶
                <p>No fleet carriers added yet</p>
            </div>
        </div>

        <!-- Route Plotter -->
        <div id="routeSection" class="card hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h2 class="subheader" style="margin-bottom: 0;">üìà Route Planner</h2>
                <button class="btn-primary" onclick="updateRoutes()">üîÑ Refresh Routes</button>
            </div>
            <div id="routeContent"></div>
        </div>

        <!-- Mission Summary -->
        <div id="summarySection" class="card hidden">
            <h2 class="subheader">üïê Active Mission Summary</h2>
            <div class="overflow-auto">
                <table id="summaryTable"></table>
            </div>
        </div>

        <!-- Expired Missions -->
        <div id="expiredSection" class="card hidden">
            <h2 class="subheader">üïê Expired Missions (No longer active)</h2>
            <div class="overflow-auto">
                <table id="expiredTable"></table>
            </div>
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="card">
            <div class="empty-state">
                üì¶
                <h3 style="font-size: 1.125rem; font-weight: 500; color: #6b7280; margin-bottom: 0.5rem;">No Data Yet
                </h3>
                <p>Upload Elite Dangerous journal files to get started</p>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let commanders = {};
        let missions = {};
        let expiredMissions = {};
        let commodities = [];
        let fleetCarriers = {};
        let uploadedFiles = [];
        let folderStats = {}; // Track files and missions per folder
        let expandedRows = new Set();
        let routeProgress = {};

        // Initialize app
        document.addEventListener('DOMContentLoaded', function () {
            loadFromStorage();
            updateUI();

            // File input handler
            document.getElementById('fileInput').addEventListener('change', handleFileUpload);

            // Enter key handlers
            document.getElementById('newCommodity').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') addCommodity();
            });

            document.getElementById('newCarrier').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') addFleetCarrier();
            });
        });

        // LocalStorage functions
        function saveToStorage() {
            try {
                localStorage.setItem('eliteED_commodities', JSON.stringify(commodities));
                localStorage.setItem('eliteED_fleetCarriers', JSON.stringify(fleetCarriers));
            } catch (e) {
                console.error('Failed to save to localStorage:', e);
            }
        }

        function loadFromStorage() {
            try {
                const savedCommodities = localStorage.getItem('eliteED_commodities');
                if (savedCommodities) {
                    commodities = JSON.parse(savedCommodities);
                }

                const savedCarriers = localStorage.getItem('eliteED_fleetCarriers');
                if (savedCarriers) {
                    fleetCarriers = JSON.parse(savedCarriers);
                }
            } catch (e) {
                console.error('Failed to load from localStorage:', e);
            }
        }

        // File upload and parsing
        function handleFileUpload(event) {
            const files = Array.from(event.target.files);

            console.log(`Total files selected: ${files.length}`);

            // More flexible filter for Journal log files
            const journalFiles = files.filter(file => {
                return file.name.match(/^Journal.*\.log$/i);
            });

            console.log(`Found ${journalFiles.length} journal files out of ${files.length} total files`);

            if (journalFiles.length === 0) {
                alert(`No Journal log files found in selected folder and its subfolders.           
                    Found ${files.length} total files, but none matched the pattern "Journal*.log".
                    Please select a folder containing Elite Dangerous journal files (they should start with "Journal" and end with ".log").
                    Check the browser console for a list of all files found.`);

                console.log('All files found:');
                files.forEach(file => console.log(`- ${file.webkitRelativePath}`));
                return;
            }

            // Group files by their immediate parent folder (CMDR folders)
            const cmdrFolders = {};
            journalFiles.forEach(file => {
                const pathParts = file.webkitRelativePath.split('/');
                // Get the folder that directly contains the .log file
                const cmdrFolder = pathParts[pathParts.length - 2] || pathParts[0];

                if (!cmdrFolders[cmdrFolder]) {
                    cmdrFolders[cmdrFolder] = [];
                }
                cmdrFolders[cmdrFolder].push(file);
            });

            const folderNames = Object.keys(cmdrFolders);
            console.log(`Found ${folderNames.length} commander folders:`, folderNames);

            // Clear existing data
            commanders = {};
            missions = {};
            expiredMissions = {};
            uploadedFiles = [];
            folderStats = {};

            // Collect all mission events from all files first
            const globalMissionEvents = new Map(); // missionId -> latest event data
            const globalCompletedMissions = new Set();
            const globalFailedMissions = new Set();
            const globalAbandonedMissions = new Set();

            let processedFiles = 0;
            let totalFiles = 0;

            // Count total files to process
            folderNames.forEach(folderName => {
                totalFiles += cmdrFolders[folderName].length;
            });

            // Process each CMDR folder
            folderNames.forEach(folderName => {
                const folderFiles = cmdrFolders[folderName];
                console.log(`Processing folder: ${folderName} - ${folderFiles.length} journal files`);

                // Initialize folder stats
                folderStats[folderName] = {
                    filesScanned: folderFiles.length,
                    missionsFound: 0
                };

                folderFiles.forEach(file => {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        const content = e.target.result;
                        const result = parseLogFile(content, file.name);

                        if (result.commanderName) {
                            if (!commanders[result.commanderName]) {
                                commanders[result.commanderName] = {
                                    name: result.commanderName,
                                    cargoCapacity: 752
                                };
                            }

                            // Track mission events globally
                            result.globalEvents.acceptedMissions.forEach((mission, missionId) => {
                                globalMissionEvents.set(missionId, { mission, commanderName: result.commanderName });
                            });

                            result.globalEvents.completedMissions.forEach(missionId => {
                                globalCompletedMissions.add(missionId);
                            });

                            result.globalEvents.failedMissions.forEach(missionId => {
                                globalFailedMissions.add(missionId);
                            });

                            result.globalEvents.abandonedMissions.forEach(missionId => {
                                globalAbandonedMissions.add(missionId);
                            });
                        }

                        // Track processed folders
                        if (!uploadedFiles.includes(folderName)) {
                            uploadedFiles.push(folderName);
                        }

                        processedFiles++;

                        // After processing all files, filter missions globally
                        if (processedFiles === totalFiles) {
                            processGlobalMissions(globalMissionEvents, globalCompletedMissions, globalFailedMissions, globalAbandonedMissions);
                            updateUI();
                        }
                    };
                    reader.readAsText(file);
                });
            });
        }

        function processGlobalMissions(globalMissionEvents, globalCompletedMissions, globalFailedMissions, globalAbandonedMissions) {
            // Clear previous mission data
            missions = {};
            expiredMissions = {};

            globalMissionEvents.forEach(({ mission, commanderName }, missionId) => {
                // Skip missions that were completed, failed, or abandoned
                if (globalCompletedMissions.has(missionId) || globalFailedMissions.has(missionId) || globalAbandonedMissions.has(missionId)) {
                    return;
                }

                // Initialize commander mission arrays if needed
                if (!missions[commanderName]) {
                    missions[commanderName] = [];
                }
                if (!expiredMissions[commanderName]) {
                    expiredMissions[commanderName] = [];
                }

                // Check if mission is expired
                if (mission.expiry && new Date(mission.expiry) <= new Date()) {
                    expiredMissions[commanderName].push(mission);
                } else {
                    missions[commanderName].push(mission);
                }
            });

            // Update folder stats
            Object.keys(folderStats).forEach(folderName => {
                folderStats[folderName].missionsFound = 0;
                Object.keys(missions).forEach(commanderName => {
                    folderStats[folderName].missionsFound += missions[commanderName].length;
                });
            });
        }

        function parseLogFile(content, fileName) {
            const lines = content.split('\n').filter(line => line.trim());
            let commanderName = null;
            const acceptedMissions = new Map(); // Track accepted missions by ID
            const completedMissionIds = new Set(); // Track completed mission IDs
            const failedMissionIds = new Set(); // Track failed mission IDs
            const abandonedMissionIds = new Set(); // Track abandoned mission IDs

            // Process all mission events
            lines.forEach(line => {
                try {
                    const event = JSON.parse(line);

                    if (event.event === 'Commander') {
                        commanderName = event.Name;
                    }

                    // Track accepted mining/industrial missions
                    if (event.event === 'MissionAccepted' &&
                        (event.Name === 'Mission_Mining' || event.Name === 'Mission_Collect_Industrial')) {
                        const mission = {
                            missionId: event.MissionID,
                            type: event.Name,
                            commodity: event.Commodity_Localised || event.Commodity || 'Unknown',
                            count: event.Count,
                            faction: event.Faction,
                            expiry: event.Expiry,
                            reward: event.Reward,
                            localizedName: event.LocalisedName
                        };
                        acceptedMissions.set(event.MissionID, mission);
                    }

                    // Track completed missions
                    if (event.event === 'MissionCompleted') {
                        completedMissionIds.add(event.MissionID);
                    }

                    // Track failed missions
                    if (event.event === 'MissionFailed') {
                        failedMissionIds.add(event.MissionID);
                    }

                    // Track abandoned missions
                    if (event.event === 'MissionAbandoned') {
                        abandonedMissionIds.add(event.MissionID);
                    }

                } catch (e) {
                    // Skip invalid JSON lines
                }
            });

            return {
                commanderName,
                globalEvents: {
                    acceptedMissions,
                    completedMissions: completedMissionIds,
                    failedMissions: failedMissionIds,
                    abandonedMissions: abandonedMissionIds
                }
            };
        }

        // Commodities functions
        function addCommodity() {
            const input = document.getElementById('newCommodity');
            const commodity = input.value.trim();

            if (commodity && !commodities.includes(commodity)) {
                commodities.push(commodity);

                // Add to all fleet carriers
                Object.keys(fleetCarriers).forEach(carrierName => {
                    if (!fleetCarriers[carrierName][commodity]) {
                        fleetCarriers[carrierName][commodity] = 0;
                    }
                });

                input.value = '';
                saveToStorage();
                updateUI();
            }
        }

        function removeCommodity(commodity) {
            commodities = commodities.filter(c => c !== commodity);

            // Remove from all fleet carriers
            Object.keys(fleetCarriers).forEach(carrierName => {
                delete fleetCarriers[carrierName][commodity];
            });

            saveToStorage();
            updateUI();
        }

        function addSuggestedCommodity(commodity) {
            if (!commodities.includes(commodity)) {
                commodities.push(commodity);

                // Add to all fleet carriers
                Object.keys(fleetCarriers).forEach(carrierName => {
                    if (!fleetCarriers[carrierName][commodity]) {
                        fleetCarriers[carrierName][commodity] = 0;
                    }
                });

                saveToStorage();
                updateUI();
            }
        }

        function getSuggestedCommodities() {
            const found = new Set();

            Object.keys(missions).forEach(commanderName => {
                const commanderMissions = missions[commanderName] || [];
                commanderMissions.forEach(mission => {
                    if (mission.commodity) {
                        found.add(mission.commodity);
                    }
                });
            });

            return Array.from(found).filter(commodity => !commodities.includes(commodity));
        }

        // Fleet Carriers functions
        function addFleetCarrier() {
            const input = document.getElementById('newCarrier');
            const carrierName = input.value.trim();

            if (carrierName && !fleetCarriers[carrierName]) {
                fleetCarriers[carrierName] = {};

                // Initialize with all commodities
                commodities.forEach(commodity => {
                    fleetCarriers[carrierName][commodity] = 0;
                });

                input.value = '';
                saveToStorage();
                updateUI();
            }
        }

        function removeFleetCarrier(carrierName) {
            delete fleetCarriers[carrierName];
            saveToStorage();
            updateUI();
        }

        function updateCarrierAmount(carrierName, commodity, amount) {
            if (fleetCarriers[carrierName]) {
                fleetCarriers[carrierName][commodity] = parseInt(amount) || 0;
                saveToStorage();
                updateUI(); // Add this line to refresh the table footer
            }
        }

        // Utility functions
        function formatTimeRemaining(expiry) {
            if (!expiry) return 'Unknown';
            const expiryDate = new Date(expiry);
            const now = new Date();
            const diff = expiryDate - now;

            if (diff <= 0) return 'Expired';

            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

            if (hours > 24) {
                const days = Math.floor(hours / 24);
                return `${days}d ${hours % 24}h`;
            }
            return `${hours}h ${minutes}m`;
        }

        function toggleRowExpansion(rowId) {
            if (expandedRows.has(rowId)) {
                expandedRows.delete(rowId);
            } else {
                expandedRows.add(rowId);
            }
            updateUI();
        }

        function toggleRouteProgress(key) {
            routeProgress[key] = !routeProgress[key];
            updateUI();
        }

        // Route generation
        function generateRoutes() {
            const commanderNames = Object.keys(missions).filter(cmd => missions[cmd]?.length > 0);
            if (commanderNames.length === 0) return [];

            const routeData = {};

            const findFleetCarrierForCommodity = (commodity) => {
                for (const [carrierName, commodities] of Object.entries(fleetCarriers)) {
                    if (commodities[commodity] && commodities[commodity] > 0) {
                        return carrierName;
                    }
                }
                return null;
            };

            commanderNames.forEach(commanderName => {
                const commanderMissions = missions[commanderName] || [];
                const cargoCapacity = commanders[commanderName]?.cargoCapacity || 752;

                const commodityGroups = {};
                commanderMissions.forEach(mission => {
                    if (!commodityGroups[mission.commodity]) {
                        commodityGroups[mission.commodity] = [];
                    }
                    commodityGroups[mission.commodity].push({ ...mission });
                });

                const trips = [];
                Object.keys(commodityGroups).forEach(commodity => {
                    const missionsForCommodity = commodityGroups[commodity];
                    const totalNeeded = missionsForCommodity.reduce((sum, m) => sum + m.count, 0);
                    const tripsNeeded = Math.ceil(totalNeeded / cargoCapacity);

                    let remainingMissions = [...missionsForCommodity];

                    for (let trip = 1; trip <= tripsNeeded; trip++) {
                        let cargoHold = cargoCapacity;
                        const deliveries = [];
                        const completedMissions = [];

                        while (cargoHold > 0 && remainingMissions.length > 0) {
                            const mission = remainingMissions[0];
                            const amountToDeliver = Math.min(cargoHold, mission.count);

                            deliveries.push({
                                missionId: mission.missionId,
                                commodity: mission.commodity,
                                amount: amountToDeliver,
                                faction: mission.faction,
                                isPartial: amountToDeliver < mission.count
                            });

                            mission.count -= amountToDeliver;
                            cargoHold -= amountToDeliver;

                            if (mission.count === 0) {
                                completedMissions.push(mission.missionId);
                                remainingMissions.shift();
                            }
                        }

                        const carrierName = findFleetCarrierForCommodity(commodity);

                        trips.push({
                            tripNumber: trip,
                            commodity,
                            cargoToLoad: cargoCapacity - cargoHold,
                            carrierName,
                            deliveries,
                            completedMissions
                        });
                    }
                });

                routeData[commanderName] = trips;
            });

            const maxTrips = Math.max(...commanderNames.map(cmd => routeData[cmd].length));
            const tripGroups = [];

            for (let tripIndex = 0; tripIndex < maxTrips; tripIndex++) {
                const tripNum = tripIndex + 1;
                const tripActions = [];

                const hasAnyTrip = commanderNames.some(cmd => routeData[cmd][tripIndex]);
                if (!hasAnyTrip) continue;

                // Fly to FC
                tripActions.push({
                    id: `fly-fc-${tripNum}`,
                    action: 'Fly to FC',
                    commanders: commanderNames.reduce((acc, cmd) => {
                        const trip = routeData[cmd][tripIndex];
                        if (trip) {
                            const destination = trip.carrierName || `Fleet Carrier for ${trip.commodity}`;
                            acc[cmd] = `‚Üí ${destination}`;
                        } else {
                            acc[cmd] = '';
                        }
                        return acc;
                    }, {})
                });

                // Purchase Commodities
                tripActions.push({
                    id: `purchase-${tripNum}`,
                    action: 'Purchase Commodities',
                    commanders: commanderNames.reduce((acc, cmd) => {
                        const trip = routeData[cmd][tripIndex];
                        acc[cmd] = trip ? `${trip.cargoToLoad}t ${trip.commodity}` : '';
                        return acc;
                    }, {})
                });

                // Fly to Station
                tripActions.push({
                    id: `fly-station-${tripNum}`,
                    action: 'Fly to Station',
                    commanders: commanderNames.reduce((acc, cmd) => {
                        const trip = routeData[cmd][tripIndex];
                        acc[cmd] = trip ? 'Return to Station' : '';
                        return acc;
                    }, {})
                });

                // Deliver to Mission(s)
                const maxDeliveries = Math.max(...commanderNames.map(cmd => {
                    const trip = routeData[cmd][tripIndex];
                    return trip ? trip.deliveries.length : 0;
                }));

                for (let deliveryIndex = 0; deliveryIndex < maxDeliveries; deliveryIndex++) {
                    tripActions.push({
                        id: `deliver-${tripNum}-${deliveryIndex}`,
                        action: 'Deliver to Mission',
                        commanders: commanderNames.reduce((acc, cmd) => {
                            const trip = routeData[cmd][tripIndex];
                            if (trip && trip.deliveries[deliveryIndex]) {
                                const delivery = trip.deliveries[deliveryIndex];
                                const partialText = delivery.isPartial ? ' (partial)' : '';
                                acc[cmd] = `${delivery.amount}t ${delivery.commodity} | ${delivery.faction}${partialText}`;
                            } else {
                                acc[cmd] = '';
                            }
                            return acc;
                        }, {})
                    });
                }

                // Complete Mission
                const anyCompletions = commanderNames.some(cmd => {
                    const trip = routeData[cmd][tripIndex];
                    return trip && trip.completedMissions.length > 0;
                });

                if (anyCompletions) {
                    tripActions.push({
                        id: `complete-${tripNum}`,
                        action: 'Complete Mission',
                        commanders: commanderNames.reduce((acc, cmd) => {
                            const trip = routeData[cmd][tripIndex];
                            if (trip && trip.completedMissions.length > 0) {
                                acc[cmd] = `${trip.completedMissions.length} mission(s) completed`;
                            } else {
                                acc[cmd] = '';
                            }
                            return acc;
                        }, {})
                    });
                }

                tripGroups.push({
                    tripNumber: tripNum,
                    actions: tripActions,
                    commanders: commanderNames
                });
            }

            return tripGroups;
        }

        // UI Update functions
        function updateUI() {
            updateFileList();
            updateCommodities();
            updateFleetCarriers();
            updateCommanders();
            updateExpiredMissions();
            updateSummary();
            updateRoutes();
            updateEmptyState();
        }

        function updateFileList() {
            const container = document.getElementById('uploadedFiles');
            const list = document.getElementById('fileList');

            if (uploadedFiles.length > 0) {
                container.classList.remove('hidden');

                let html = '';
                uploadedFiles.forEach(folder => {
                    const stats = folderStats[folder] || { filesScanned: 0, missionsFound: 0 };

                    html += `
                        <div style="display: inline-block; margin: 0.5rem; padding: 0.75rem; background: #192946; border: 1px solid #f7e8a355; border-radius: 0.5rem; min-width: 180px;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <span style="font-size: 1.2rem;">üìÅ</span>
                                <span style="font-weight: 600; font-size: 0.875rem;">${folder}</span>
                            </div>
                            <div style="font-size: 0.75rem; color: #6b7280; line-height: 1.3;">
                                <div>‚Üí ${stats.filesScanned} Log files scanned</div>
                                <div>‚Üí ${stats.missionsFound} Missions found</div>
                            </div>
                        </div>
                    `;
                });

                list.innerHTML = html;
            } else {
                container.classList.add('hidden');
            }
        }

        function updateCommodities() {
            const activeCommodities = document.getElementById('activeCommodities');
            const suggestedCommodities = document.getElementById('suggestedCommodities');
            const noCommodities = document.getElementById('noCommodities');
            const commodityList = document.getElementById('commodityList');
            const suggestedList = document.getElementById('suggestedList');

            // Active commodities
            if (commodities.length > 0) {
                activeCommodities.classList.remove('hidden');
                noCommodities.classList.add('hidden');
                commodityList.innerHTML = commodities.map(commodity =>
                    `<span class="tag tag-green">
                        ${commodity}
                        <button onclick="removeCommodity('${commodity}')" style="background: none; border: none; color: #f7e8a3; cursor: pointer; margin-left: 0.25rem;">√ó</button>
                    </span>`
                ).join('');
            } else {
                activeCommodities.classList.add('hidden');
                noCommodities.classList.remove('hidden');
            }

            // Suggested commodities
            const suggested = getSuggestedCommodities();
            if (suggested.length > 0) {
                suggestedCommodities.classList.remove('hidden');
                suggestedList.innerHTML = suggested.map(commodity =>
                    `<span class="tag tag-blue" onclick="addSuggestedCommodity('${commodity}')">
                        ${commodity} +
                    </span>`
                ).join('');
            } else {
                suggestedCommodities.classList.add('hidden');
            }
        }

        function updateFleetCarriers() {
            const carrierTable = document.getElementById('carrierTable');
            const noCarriers = document.getElementById('noCarriers');

            if (commodities.length > 0) {
                carrierTable.classList.remove('hidden');
                noCarriers.classList.add('hidden');

                // Calculate total required quantities from all active missions
                const totalRequired = {};
                commodities.forEach(commodity => {
                    totalRequired[commodity] = 0;
                });

                Object.keys(missions).forEach(commanderName => {
                    const commanderMissions = missions[commanderName] || [];
                    commanderMissions.forEach(mission => {
                        if (totalRequired.hasOwnProperty(mission.commodity)) {
                            totalRequired[mission.commodity] += mission.count;
                        }
                    });
                });

                // Calculate total available in all fleet carriers
                const totalAvailable = {};
                commodities.forEach(commodity => {
                    totalAvailable[commodity] = 0;
                    Object.keys(fleetCarriers).forEach(carrierName => {
                        totalAvailable[commodity] += fleetCarriers[carrierName][commodity] || 0;
                    });
                });

                let html = '<table><thead><tr><th>Fleet Carrier</th>';
                commodities.forEach(commodity => {
                    html += `<th class="text-center">${commodity}</th>`;
                });
                html += '<th class="text-center">Action</th></tr></thead><tbody>';

                // Fleet Carrier rows (show placeholder if none exist)
                if (Object.keys(fleetCarriers).length === 0) {
                    html += `<tr>
                <td colspan="${commodities.length + 2}" class="text-center" style="padding: 2rem; color: #6b7280; font-style: italic;">
                Please enter one or more Fleet Carriers above to track commodity inventory
                </td>
                </tr>`;
                } else {
                    Object.keys(fleetCarriers).forEach(carrierName => {
                        html += `<tr><td>${carrierName}</td>`;
                        commodities.forEach(commodity => {
                            const amount = fleetCarriers[carrierName][commodity] || 0;
                            html += `<td class="text-center">
                            <input type="number" value="${amount}" min="0" 
                            onchange="updateCarrierAmount('${carrierName}', '${commodity}', this.value)"
                            style="width: 80px; text-align: center; border: none; background: transparent; color: #f7e8a3;">
                            </td>`;
                        });
                        html += `<td class="text-center">
                        <button class="btn-red" onclick="removeFleetCarrier('${carrierName}')">Remove</button>
                        </td></tr>`;
                    });
                }

                // Footer: Total Required row
                html += `<tr style="background-color: #f59e0b; border-top: 2px solid #d97706;">
                <td style="font-weight: 600; color: #192946;">Total Required</td>`;
                commodities.forEach(commodity => {
                    html += `<td class="text-center" style="font-weight: 600; color: #192946;">${totalRequired[commodity]}t</td>`;
                });
                html += '<td class="text-center" style="color: #192946;"></td></tr>';

                // Footer: Net Result row
                html += `<tr style="background-color: #1e40af; border-top: 1px solid #0ea5e9;">
                <td style="font-weight: 600; color: #f7e8a3;">Net Result</td>`;
                commodities.forEach(commodity => {
                    const netResult = totalAvailable[commodity] - totalRequired[commodity];
                    const resultClass = netResult >= 0 ? 'text-green' : 'text-red';
                    const sign = netResult >= 0 ? '+' : '';
                    html += `<td class="text-center ${resultClass}" style="font-weight: 600;">${sign}${netResult}t</td>`;
                });
                html += '<td class="text-center" style="color: #f7e8a3;"></td></tr>';

                html += '</tbody></table>';
                carrierTable.innerHTML = html;
            } else {
                carrierTable.classList.add('hidden');
                noCarriers.classList.remove('hidden');
            }
        }

        function updateCommanders() {
            const section = document.getElementById('commandersSection');
            const table = document.getElementById('commandersTable');

            if (Object.keys(commanders).length > 0) {
                section.classList.remove('hidden');

                let html = '<thead><tr><th>Commander</th><th class="text-center">Cargo Capacity (t)</th><th class="text-center">Active Missions</th></tr></thead><tbody>';

                Object.keys(commanders).forEach(commanderName => {
                    const activeMissions = missions[commanderName]?.length || 0;
                    const expiredCount = expiredMissions[commanderName]?.length || 0;

                    html += `<tr>
                        <td>${commanderName}</td>
                        <td class="text-center">
                            <input type="number" value="${commanders[commanderName].cargoCapacity}" min="0"
                                   onchange="updateCargoCapacity('${commanderName}', this.value)"
                                   style="width: 80px; text-align: center; background: transparent; border: none; color: #f7e8a3;">
                        </td>
                        <td class="text-center">
                            ${activeMissions}
                            ${expiredCount > 0 ? `<span class="text-red" style="font-size: 0.75rem; margin-left: 0.5rem;">(${expiredCount} expired)</span>` : ''}
                        </td>
                    </tr>`;
                });

                html += '</tbody>';
                table.innerHTML = html;
            } else {
                section.classList.add('hidden');
            }
        }

        function updateCargoCapacity(commanderName, capacity) {
            commanders[commanderName].cargoCapacity = parseInt(capacity) || 0;
            updateUI();
        }

        function updateExpiredMissions() {
            const section = document.getElementById('expiredSection');
            const table = document.getElementById('expiredTable');

            const hasExpired = Object.keys(expiredMissions).some(cmd => expiredMissions[cmd]?.length > 0);

            if (hasExpired) {
                section.classList.remove('hidden');

                let html = '<thead><tr style="background-color: #dc2626;"><th>CMDR</th><th>Commodity</th><th class="text-right">Amount (t)</th><th>Mission ID</th><th>Faction</th><th>Expired</th></tr></thead><tbody>';

                Object.keys(expiredMissions).forEach(commanderName => {
                    expiredMissions[commanderName]?.forEach(mission => {
                        html += `<tr>
                            <td>${commanderName}</td>
                            <td>${mission.commodity}</td>
                            <td class="text-right font-mono">${mission.count}</td>
                            <td>${mission.missionId}</td>
                            <td>${mission.faction}</td>
                            <td><span class="status-badge status-expired">${formatTimeRemaining(mission.expiry)}</span></td>
                        </tr>`;
                    });
                });

                html += '</tbody>';
                table.innerHTML = html;
            } else {
                section.classList.add('hidden');
            }
        }

        function updateSummary() {
            const section = document.getElementById('summarySection');
            const table = document.getElementById('summaryTable');

            const summaryData = [];

            Object.keys(missions).forEach(commanderName => {
                const commanderMissions = missions[commanderName];

                // Create a row for each individual mission instead of grouping by commodity
                commanderMissions.forEach(mission => {
                    summaryData.push({
                        id: `${commanderName}-${mission.missionId}`,
                        commander: commanderName,
                        commodity: mission.commodity,
                        amount: mission.count,
                        timer: formatTimeRemaining(mission.expiry),
                        mission: mission // Single mission instead of array
                    });
                });
            });

            if (summaryData.length > 0) {
                section.classList.remove('hidden');

                let html = '<thead><tr><th style="width: 2rem;"></th><th>CMDR</th><th>Commodity</th><th class="text-right">Amount (t)</th><th>Timer</th></tr></thead><tbody>';

                summaryData.forEach(row => {
                    const isExpanded = expandedRows.has(row.id);
                    const timerClass = row.timer.includes('Expired') ? 'status-expired' :
                        row.timer.includes('h') && !row.timer.includes('d') ? 'status-urgent' : 'status-good';

                    html += `<tr class="expandable-row" onclick="toggleRowExpansion('${row.id}')">
                        <td class="text-center">${isExpanded ? '‚ñº' : '‚ñ∂'}</td>
                        <td>${row.commander}</td>
                        <td>${row.commodity}</td>
                        <td class="text-right font-mono">${row.amount}</td>
                        <td><span class="status-badge ${timerClass}">${row.timer}</span></td>
                    </tr>`;

                    if (isExpanded) {
                        const mission = row.mission;
                        html += `<tr><td colspan="5" class="expanded-content">
                            <h4 style="font-weight: 500; margin-bottom: 0.5rem;">Mission Details:</h4>
                            <div class="mission-card" style="max-width: 400px;">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div>
                                        <p style="font-weight: 500;">Mission ID: ${mission.missionId}</p>
                                        <p style="font-size: 0.875rem; color: #6b7280;">Faction: ${mission.faction}</p>
                                        <p style="font-size: 0.875rem;">Amount: ${mission.count}t</p>
                                        <p style="font-size: 0.875rem;">Type: ${mission.type === 'Mission_Mining' ? 'Mining' : 'Industrial'}</p>
                                    </div>
                                    <div style="text-align: right;">
                                        <p style="font-size: 0.875rem; font-weight: 500; color: #3b82f6;">
                                            ${mission.reward?.toLocaleString()} Cr
                                        </p>
                                        <p style="font-size: 0.875rem; color: #6b7280;">
                                            ${formatTimeRemaining(mission.expiry)}
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </td></tr>`;
                    }
                });

                html += '</tbody>';
                table.innerHTML = html;
            } else {
                section.classList.add('hidden');
            }
        }

        function updateRoutes() {
            const section = document.getElementById('routeSection');
            const content = document.getElementById('routeContent');

            const tripGroups = generateRoutes();

            if (tripGroups.length > 0) {
                section.classList.remove('hidden');

                let html = '';
                tripGroups.forEach(tripGroup => {
                    html += `<div class="trip-card">
                    <div class="trip-header">TRIP #${tripGroup.tripNumber}</div>
                    <table class="trip-table">
                        <thead>
                            <tr>
                                <th style="width: 3rem; text-align: center;">‚úì</th>
                                <th style="min-width: 8rem;">Action</th>`;

                    tripGroup.commanders.forEach(commander => {
                        html += `<th style="min-width: 12rem;">${commander}</th>`;
                    });

                    html += `</tr></thead><tbody>`;

                    tripGroup.actions.forEach((actionRow, index) => {
                        const progressKey = actionRow.id;
                        const isChecked = routeProgress[progressKey];

                        html += `<tr>
                        <td class="text-center">
                            <input type="checkbox" ${isChecked ? 'checked' : ''} 
                                onchange="toggleRouteProgress('${progressKey}')">
                        </td>
                        <td class="action-col">${actionRow.action}</td>`;

                        tripGroup.commanders.forEach(commander => {
                            const content = actionRow.commanders[commander];

                            html += `<td>`;
                            if (content) {
                                html += `<span class="${isChecked ? 'strikethrough' : ''}">${content}</span>`;
                            }
                            html += `</td>`;
                        });

                        html += '</tr>';
                    });
                    html += '</tbody></table></div>';
                });

                content.innerHTML = html;
            } else {
                section.classList.add('hidden');
            }
        }

        function updateEmptyState() {
            const emptyState = document.getElementById('emptyState');
            const hasData = Object.keys(commanders).length > 0;

            if (hasData) {
                emptyState.classList.add('hidden');
            } else {
                emptyState.classList.remove('hidden');
            }
        }
    </script>
</body>
</html>
